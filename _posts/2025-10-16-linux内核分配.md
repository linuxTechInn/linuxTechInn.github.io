---
layout: post
title: 内存分配
date: 2025-10-16 22:43:19 
last_modified_at: 2025-10-16 22:43:19 
tags: []
author: Daniel
toc: true
description: linux的free内存管理和分配策略
---
# 内存分配

### free内存管理架构图

![image-20251016233423973](https://raw.githubusercontent.com/JJcodo/Pictures/main/image-20251016233423973.png)

free内存管理系统按层次来看有以下层次

#### 1、节点

手机当中只有一个节点，暂不分析

#### 2、zone类型

zone一般有DMA、DMA32、NORMAL、HIGHMEM、MOVABLE。
DMA和DMA32：通过给他们分配低地址的内存，是其能够满足32位或者更低位设备的寻址要求。

NORMAL：   这个zone是用于给内核进行直接线性映射访问，简单说就是通过page_address（page）就能直接得到这个page虚拟地址，不需要临时建立映射。

HIGHMEM ：这个zone通常是给32位计算机访问的，在64位机器上不涉及，访问这部分内存需要建立临时映射，访问速度会比较慢。

MOVABLE：  这个zone是只能用于Movable类型的申请，它的目的是为了防止内存碎片化、并支持内存可插拔特性，然而，因为手机的相机对于DMABUF内存的需求非常大，这些内存都是不可移动内存，因此，手机中使用Movable Zone的代价会比较大，管理上会很复杂。

#### 3、迁移类型

RECLAIMABLE：这种类型的使用者比较少，一般是slab reclaim在使用，也因此这种类型在手机内核当中的占用也不多。

UNMOVABLE:    不可移动类型的内存，内核里面这种类型的使用者比较多，像一般的alloc_page或者slab_alloc、DMABUF内存和GPU内存都是使用的是这种类型的内存。

MOVABLE:          可移动类型的内存，除了匿名页和文件页之外，内核里面使用这种类型的内存需要实现movable_operations的方法，支持page的迁移功能，如果用户申请了Movable类型的内存，但是却没有真正实现movable_operations的方法，很有可能会引起一些因为页迁移失败，并导致一些无法接受的问题（比如：如果用户申请到了CMA类型的内存，但是因为没有不支持迁移导致CMA内存申请的时候失败了，就会导致驱动的功能失效）。
HIGHATOMIC:    高阶原子类型的内存，只用来供给高阶原子类型的内存，它有个独特的机制，预留高阶页，这个机制可以让他通过一些简单的HOOK点（还没有提交）预留更多的高阶页，达成减少碎片化、增加高阶页申请的目的。

CMA				: CMA内存区域类型的内存，CMA是一段连续的内存，当这块内存被buddy系统复用的时候，这块内存就会被赋予独特的迁移类型，CMA类型，申请这个区域的内存，需要保证，所有page都是可以迁移的，绝对不允许出现，不能支持迁移的申请使用这块类型的内存。

ISOLATE		: LSOLATE类型的内存其实不是一个常用的类型，这只是一个临时的状态，用于保存被隔离的free page，使得这些page不会被buddy系统再次分配出去。

以上，就是buddy系统各个层次的介绍。

#### 4、page的合并和拆分（buddy算法）

buddy算法核心-合并：

```c

// 通过异或算法，反转第order位的地址找到伙伴page的地址 
__buddy_pfn = page_pfn ^ (1 << order);
// 计算 buddy page
buddy = page + (__buddy_pfn - pfn);
// 满足下面两个条件的buddy page就可以被合并
// 1.buddy page属于buddy系统
// 2.buddy page 的oder和page的order相等
PageBuddy(buddy) && buddy_order(buddy) == order
```

#### 5、PCP page

