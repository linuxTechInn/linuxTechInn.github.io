---
layout: post
title: F2FS原子写
date: 2025-08-03 23:03:15 
last_modified_at: 2025-08-03 23:03:15 
tags: []
author: wangzijie
toc: true
description: 文章描述


---

# F2FS原子写

由于终端设备中使用的sqlite数据库是一个支持事务的数据库，那么支持sqlite的底层文件系统，为了实现更好的可靠性，也要去支持sqlite对于事务性写入的需求，F2FS通过新增ioctl实现了原子写，在sqlite源代码中，也能看到对F2FS原子写ioctl的调用。

原子写在5.1X版本经历过一次重构，还是看重构后的原子写实现吧。



## 从提供的写相关ioctl看

先从事务性写入的角度来理解提供出来的ioctl接口：

当需要原子写:

1. 由F2FS_IOC_START_ATOMIC_WRITE接口来开启一个写入事务

2. 写入数据

3. 由F2FS_IOC_COMMIT_ATOMIC_WRITE接口来提交写入事务



### 事务开启

```c
f2fs_ioc_start_atomic_write
	->f2fs_get_tmpfile
  	->f2fs_acquire_orphan_inode
  	->f2fs_do_tmpfile
  	->f2fs_add_orphan_inode
	->set_inode_flag(inode, FI_ATOMIC_FILE);		
```

要被原子写的文件，f2fs_inode_info中记录一个cow_inode，事务开启的时候为它创建一个tmpfile，同时挂到孤儿节点的list中。这个要被原子写的文件在最后打上ATOMIC标记。



### 数据写入

数据写入上，对于写pagecache和回写，都需要单独处理cow inode。



### 事务提交

```c
f2fs_ioc_commit_atomic_write
  ->__f2fs_commit_atomic_write
  	->循环调用__replace_atomic_write_block
```

遍历cow_inode中的block，每一个都替换给原inode，完成提交。
