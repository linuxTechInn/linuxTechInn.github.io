---
layout: post
title: ubuntu更换自定义内核
date: 2025-08-08 00:17:01 
last_modified_at: 2025-08-08 00:17:01 
tags: [环境配置]
author: Daniel
toc: true
description: 介绍如何ubuntu如何更换自定义的内核
---
# ubuntu更换自定义内核

工欲善其事必先利其器

> 参考文章
>
> https://blog.csdn.net/weixin_40837318/article/details/123798456
>
> 编译内核并安装
>
> https://blog.csdn.net/star_xiong/article/details/17357821
>
> https://juejin.cn/post/7245668131011838011
>
> 配置详解
>
> http://blog.csdn.net/xuyuefei1988/article/details/8635539
>
> http://www.linuxidc.com/Linux/2012-06/63092.htm



虚拟机代理配置

1. 使用桥接模式

2. 配置git代理或者其他代理，代理地址为http://192.168.124.5:7890

   ```shell
   # 192.168.124.5 为宿主机ip
   git config --global http.proxy http://192.168.124.5:7890
   git config --global https.proxy https://192.168.124.5:7890
   ```

3. clash软件打开allow lan



<img src="https://raw.githubusercontent.com/JJcodo/Pictures/main/image-20250809010453622.png" alt="image-20250809010453622" style="zoom:50%;" />



#### 1、下载安装包

```shell
# 包含所有架构的头文件，跨架构内核头文件（用于编译模块）
wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v6.16/amd64/linux-headers-6.16.0-061600-generic_6.16.0-061600.202507272138_amd64.deb
# 包含x86架构的特定头文件，x86_64 架构内核头文件
wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v6.16/amd64/linux-headers-6.16.0-061600_6.16.0-061600.202507272138_all.deb
# 包含未签名的内核镜像，核心启动文件
wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v6.16/amd64/linux-image-unsigned-6.16.0-061600-generic_6.16.0-061600.202507272138_amd64.deb
# 包含内核模块 （ko, 驱动）
wget https://kernel.ubuntu.com/~kernel-ppa/mainline/v6.16/amd64/linux-modules-6.16.0-061600-generic_6.16.0-061600.202507272138_amd64.deb
```



#### 2、安装命令

```shell
# 安装命令1
sudo dpkg -i \
  linux-headers-6.16.0-061600_*.deb \
  linux-headers-6.16.0-061600-generic_*.deb \
  linux-modules-6.16.0-061600-generic_*.deb \
  linux-image-unsigned-6.16.0-061600-generic_*.deb
sudo update-grub  # 更新 GRUB 启动菜单
# 安装官方内核镜像
# sudo apt install linux-generic
# 或者使用安装命令
# sudo dpkg -i *.deb
```



#### 3、获取启动项

```shell
# 过滤submenu关键字，当前内核启动项
sudo grep submenu /boot/grub/grub.cfg
# 过滤gnulinux关键字，查看可用的内核启动项
sudo grep gnulinux /boot/grub/grub.cfg

# 当前id为 gnulinux-advanced-3497b891-ea1b-433d-805a-770a928546a2
submenu 'Advanced options for Ubuntu' $menuentry_id_option 'gnulinux-advanced-3497b891-ea1b-433d-805a-770a928546a2' {

# 想要使用的内核ID，recovery恢复模式， advanced高级选项
# 6.16版本
'gnulinux-6.16.0-061600-generic-advanced-3497b891-ea1b-433d-805a-770a928546a2'
'gnulinux-6.16.0-061600-generic-recovery-3497b891-ea1b-433d-805a-770a928546a2‘
# 6.11版本
'gnulinux-6.11.0-29-generic-advanced-3497b891-ea1b-433d-805a-770a928546a2'
'gnulinux-6.11.0-29-generic-recovery-3497b891-ea1b-433d-805a-770a928546a2'
```



#### 4、配置内核启动项

```shell
sudo vim /etc/default/grub
GRUB_DEFAULT='gnulinux-6.16.0-061600-generic-advanced-3497b891-ea1b-433d-805a-770a928546a2'
sudo update-grub
```



#### 5、验证版本是否成功切换

```shell
sudo reboot
uname -r
# 输出切换的版本，说明成功切换
6.16.0-061600-generic
```



#### 6、下载内核代码

```shell
# 编译环境安装
sudo apt update
sudo apt install -y build-essential libncurses-dev \
    flex bison libssl-dev libelf-dev bc git make \
    gcc g++

# 下载内核代码
wget https://www.kernel.org/pub/linux/kernel/v6.x/linux-6.16.tar.xz

# 解压内核
tar xvf linux-6.16.tar.xz

# 清理
make mrproper

# 进入 /boot路径查找当前系统的config文件，我的配置文件是 config-6.16.0-061600-generic
# 将当前系统的配置文件拷贝到代码目录下，这样就不需要执行make menuconfig之类的命令设置配置项了
cp boot/config-6.16.0-061600-generic linux_dev/linux-6.16/.config

# 修改配置，关闭签名验证
vi .config
	CONFIG_SYSTEM_TRUSTED_KEYRING=n
	CONFIG_SYSTEM_TRUSTED_KEYS=""
	CONFIG_MODULE_SIG=n
	CONFIG_SYSTEM_REVOCATION_LIST=n
	CONFIG_SYSTEM_REVOCATION_KEYS="

# 编译内核, KERNELRELEASE是为了给内核命名，这样 uname -r 执行之后6.16.0-061600-generic-daniel得到的结果就会加上用户名了，第二次
# 得把-$(whoami)去掉，不需要增加用户名
make -j$(nproc)  KERNELRELEASE=$(uname -r)-$(whoami) 2>&1 | tee build.log  # 保存完整日志到文件
	# 选择 genksyms (from source code) (GENKSYMS)

# 等待编译.......................
# 安装module 默认路径 /lib/modules/$(uname -r)-$(whoami)/

# 制作vmlinuz镜像 
sudo cp linux_dev/linux-6.16/arch/x86/boot/bzImage /boot/vmlinuz-$(uname -r)-$(whoami)
# 制作System.map
sudo cp linux_dev/linux-6.16/System.map /boot/System.map-$(uname -r)-$(whoami)
# 制作config配置
sudo cp linux_dev/linux-6.16/.config /boot/config-$(uname -r)-$(whoami)
# 进入代码路径执行安装
sudo make modules_install KERNELRELEASE=$(uname -r)-$(whoami)
# 制作initrd.img镜像
sudo mkinitramfs /lib/modules/$(uname -r)-$(whoami)  -o /boot/initrd.img-$(uname -r)-$(whoami)

# 更新配置
sudo update-grub
# 查看新增镜像的配置
sudo grep gnulinux /boot/grub/grub.cfg
# 'gnulinux-6.16.0-061600-generic-daniel-advanced-3497b891-ea1b-433d-805a-770a928546a2'
sudo vim /etc/default/grub
GRUB_DEFAULT='gnulinux-6.16.0-061600-generic-daniel-advanced-3497b891-ea1b-433d-805a-770a928546a2'
sudo update-grub
sudo reboot
uname -r

lsinitramfs /boot/initrd.img-$(uname -r) | grep -i "ko"
sudo apt install os-prober
sudo vim /etc/default/grub
GRUB_DISABLE_OS_PROBER=false

lsinitramfs /boot/initrd.img-$(uname -r)-$(whoami)| grep -i "ko"
```



