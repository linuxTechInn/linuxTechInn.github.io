---
layout: post
title: BPF监听系统状态
date: 2025-09-20 23:41:51 
last_modified_at: 2025-09-20 23:41:51 
tags: []
author: Daniel
toc: true
description: 文章描述
---
# BPF-未完成，但是不小心提交了！！！

利用BPF监听系统状态

1、内存事件

```
trace_mark_victim(tsk, cred->uid.val);
trace_mm_page_pcpu_drain(page, order, mt);
```

3、监听进程cgroup状态

```c
/* cgroup release */
TRACE_CGROUP_PATH(release, cgrp);

/* cgroup mkdir */
TRACE_CGROUP_PATH(mkdir, cgrp);

/* cgroup rmdir */
TRACE_CGROUP_PATH(rmdir, cgrp);

/* cgroup populated */
TRACE_CGROUP_PATH(notify_populated, cgrp, cgroup_is_populated(cgrp));

/* cgroup attach task */
TRACE_CGROUP_PATH(attach_task, dst_cgrp, leader, threadgroup);

/* cgroup v1 rename */
TRACE_CGROUP_PATH(rename, cgrp);

/* cgroup v1 transfer tasks */
TRACE_CGROUP_PATH(transfer_tasks, to, task, false);

/* cgroup notify frozen state */
TRACE_CGROUP_PATH(notify_frozen, cgrp, frozen);

/* cgroup freeze */
TRACE_CGROUP_PATH(freeze, cgrp);

/* cgroup unfreeze */
TRACE_CGROUP_PATH(unfreeze, cgrp);

#define TRACE_CGROUP_PATH(type, cgrp, ...)				\
	do {								\
		if (trace_cgroup_##type##_enabled()) {			\
			unsigned long flags;				\
			spin_lock_irqsave(&trace_cgroup_path_lock,	\
					  flags);			\
			cgroup_path(cgrp, trace_cgroup_path,		\
				    TRACE_CGROUP_PATH_LEN);		\
			trace_cgroup_##type(cgrp, trace_cgroup_path,	\
					    ##__VA_ARGS__);		\
			spin_unlock_irqrestore(&trace_cgroup_path_lock, \
					       flags);			\
		}							\
	} while (0)
```

4、监听页迁移事件

```c
trace_mm_migrate_pages_start(mode, reason);
trace_mm_migrate_pages(stats.nr_succeeded, stats.nr_failed_pages, stats.nr_thp_succeeded, stats.nr_thp_failed,stats.nr_thp_split, stats.nr_split, mode,reason);
trace_remove_migration_pte(pvmw.address, pte_val(pte), compound_order(new));
```

5、监听进程事件

```
/* process exit  or task exit */
trace_sched_process_exit(tsk, group_dead);

/* task free */
trace_sched_process_free(tsk);

/* new task */
trace_task_newtask(p, clone_flags);

/* almost the same as trace_task_newtask */
trace_sched_process_fork(current, p);

/* trace process hang */
trace_sched_process_hang(t);

/* exit mmap */
trace_exit_mmap(mm);
```

